name: On Pull Requests

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize

concurrency:
  # Cancel any running workflow for the same branch when new commits are pushed.
  # We group both by ref_name (available when CI is triggered by a push to a branch/tag)
  # and head_ref (available when CI is triggered by a PR).
  # For merge queue, we use merge_group to ensure each merge queue run gets its own group.
  group: "on-pull-requests-${{ github.ref_name }}-${{ github.head_ref }}-${{ github.event.merge_group.head_sha || '' }}"
  cancel-in-progress: true

jobs:
  lint-pr-title:
    name: PR Title Linter
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Lint PR title
        uses: grafana/shared-workflows/actions/lint-pr-title@19d8fb5687bb386849f7f53673c5f429e6387cf5 # v1.2.0
        with:
          config-path: "${{ github.workspace }}/.github/commitlint.config.js"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  linting-and-tests:
    name: Linting and Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup go
        uses: ./.github/actions/setup-go

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform

      - name: Ensure go mod is "tidy"
        run: |
          go mod tidy -diff
          cd tools && go mod tidy -diff

      - name: Linting
        uses: golangci/golangci-lint-action@4afd733a84b1f43292c63897423277bb7f4313a9 # v8.0.0
        with:
          version: v2.1

      - name: Ensure formatting and generation are up to date
        run: |
          make fmt
          make generate

          if ! git diff --exit-code; then
            echo "ðŸ”´ðŸ”´ðŸ”´: There are uncommitted changes. Please run 'make lint', 'make fmt', and 'make generate' and commit the changes. ðŸ”´ðŸ”´ðŸ”´"
            exit 1
          fi

      - name: Unit Tests
        run: make test

      - name: Build
        run: make build

  acceptance-tests:
    name: Acceptance Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      # Checkout the main archestra repo to get access to Helm charts and the composite action
      # - name: Checkout archestra repo
      #   uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      #   with:
      #     repository: archestra-ai/archestra
      #     path: archestra-repo
      #     persist-credentials: false

      - name: Setup go
        uses: ./.github/actions/setup-go

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform

      # Deploy Archestra Platform locally using Kind
      # This uses the pre-built archestra/platform:latest image from Docker Hub
      - name: Setup Archestra Platform
        uses: archestra-ai/archestra/.github/actions/setup-archestra-platform@2d396d65fb3680832326a1257d1231f0cc534cc7
        with:
          kind-config-path: ./.github/kind.yaml
          kind-cluster-name: archestra-ci-cluster
          helm-values-path: ./.github/values-ci.yaml
          deploy-e2e-dependencies: "false"
          build-platform-image: "false"

      # Login with default credentials and obtain an API key for acceptance tests
      # Default credentials: admin@example.com / password
      - name: Obtain API Key
        id: api-key
        run: |
          BACKEND_URL="http://localhost:9000"

          echo "Logging in with default credentials..."
          # Sign in and capture cookies
          LOGIN_RESPONSE=$(curl -s -c cookies.txt -b cookies.txt \
            -X POST "${BACKEND_URL}/api/auth/sign-in/email" \
            -H "Content-Type: application/json" \
            -H "Origin: http://localhost:3000" \
            -d '{"email":"admin@example.com","password":"password"}')

          echo "Login response: ${LOGIN_RESPONSE}"

          # Get tokens list (this creates the org token if it doesn't exist)
          echo "Fetching tokens..."
          TOKENS_RESPONSE=$(curl -s -b cookies.txt \
            -X GET "${BACKEND_URL}/api/tokens" \
            -H "Origin: http://localhost:3000")

          echo "Tokens response: ${TOKENS_RESPONSE}"

          # Extract the first token ID (organization token)
          TOKEN_ID=$(echo "${TOKENS_RESPONSE}" | jq -r '.[0].id')

          if [ -z "${TOKEN_ID}" ] || [ "${TOKEN_ID}" = "null" ]; then
            echo "Failed to get token ID"
            exit 1
          fi

          echo "Token ID: ${TOKEN_ID}"

          # Get the actual token value
          echo "Fetching token value..."
          TOKEN_VALUE_RESPONSE=$(curl -s -b cookies.txt \
            -X GET "${BACKEND_URL}/api/tokens/${TOKEN_ID}/value" \
            -H "Origin: http://localhost:3000")

          API_KEY=$(echo "${TOKEN_VALUE_RESPONSE}" | jq -r '.value')

          if [ -z "${API_KEY}" ] || [ "${API_KEY}" = "null" ]; then
            echo "Failed to get API key value"
            echo "Response: ${TOKEN_VALUE_RESPONSE}"
            exit 1
          fi

          echo "Successfully obtained API key"

          # Mask the API key in logs and set as output
          echo "::add-mask::${API_KEY}"
          echo "api-key=${API_KEY}" >> $GITHUB_OUTPUT

          # Cleanup
          rm -f cookies.txt

      - name: Run Acceptance Tests
        run: make testacc
        env:
          ARCHESTRA_BASE_URL: "http://localhost:9000"
          ARCHESTRA_API_KEY: ${{ steps.api-key.outputs.api-key }}

  zizmor:
    name: Zizmor GitHub Actions static analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      # From zizmor action docs:
      # https://github.com/zizmorcore/zizmor-action?tab=readme-ov-file#usage-with-github-advanced-security-recommended
      #
      # In this mode, the action will not fail when zizmor produces findings.
      # This is because Advanced Security encourages workflows to only fail on internal errors.
      #
      # To use workflow failure as a blocking signal, you can use GitHub's rulesets feature.
      # For more information, see:
      # https://docs.github.com/en/code-security/code-scanning/managing-code-scanning-alerts/about-code-scanning-alerts#pull-request-check-failures-for-code-scanning-alerts
      - name: Run zizmor ðŸŒˆ
        uses: zizmorcore/zizmor-action@e639db99335bc9038abc0e066dfcd72e23d26fb4 # v0.3.0
        with:
          config: .github/zizmor.yml

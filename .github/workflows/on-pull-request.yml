name: On Pull Requests

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize

concurrency:
  # Cancel any running workflow for the same branch when new commits are pushed.
  # We group both by ref_name (available when CI is triggered by a push to a branch/tag)
  # and head_ref (available when CI is triggered by a PR).
  # For merge queue, we use merge_group to ensure each merge queue run gets its own group.
  group: "on-pull-requests-${{ github.ref_name }}-${{ github.head_ref }}-${{ github.event.merge_group.head_sha || '' }}"
  cancel-in-progress: true

jobs:
  lint-pr-title:
    name: PR Title Linter
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Lint PR title
        uses: grafana/shared-workflows/actions/lint-pr-title@19d8fb5687bb386849f7f53673c5f429e6387cf5 # v1.2.0
        with:
          config-path: "${{ github.workspace }}/.github/commitlint.config.js"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  linting-and-tests:
    name: Linting and Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup go
        uses: ./.github/actions/setup-go

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform

      - name: Ensure go mod is "tidy"
        run: |
          go mod tidy -diff
          cd tools && go mod tidy -diff

      - name: Linting
        uses: golangci/golangci-lint-action@4afd733a84b1f43292c63897423277bb7f4313a9 # v8.0.0
        with:
          version: v2.1

      - name: Ensure formatting and generation are up to date
        run: |
          make fmt
          make generate

          if ! git diff --exit-code; then
            echo "ðŸ”´ðŸ”´ðŸ”´: There are uncommitted changes. Please run 'make lint', 'make fmt', and 'make generate' and commit the changes. ðŸ”´ðŸ”´ðŸ”´"
            exit 1
          fi

      - name: Unit Tests
        run: make test

      - name: Build
        run: make build

  acceptance-tests:
    name: Acceptance Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      # Archestra platform version for acceptance tests
      # Update this single value to bump the version used
      ARCHESTRA_VERSION: "1.0.4"
    steps:
      - name: Checkout project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup go
        uses: ./.github/actions/setup-go

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform

      # Deploy Archestra Platform locally using Kind
      # This uses the pre-built archestra/platform image from Docker Hub and the published Helm chart from GAR
      - name: Setup Archestra Platform
        uses: archestra-ai/archestra/.github/actions/setup-archestra-platform@8bcfd042c91a76323e13de6f04262310857f5655
        with:
          kind-config-path: ./.github/kind.yaml
          kind-cluster-name: archestra-ci-cluster
          helm-values-path: ./.github/values-ci.yaml
          helm-chart-ref: oci://europe-west1-docker.pkg.dev/friendly-path-465518-r6/archestra-public/helm-charts/archestra-platform:${{ env.ARCHESTRA_VERSION }}
          deploy-e2e-dependencies: "false"
          build-platform-image: "false"
          platform-image-tag: archestra/platform:${{ env.ARCHESTRA_VERSION }}

      # Login with default credentials and create an API key for acceptance tests
      # Default credentials: admin@example.com / password
      - name: Obtain API Key
        id: api-key
        run: |
          BACKEND_URL="http://localhost:9000"

          echo "Logging in with default credentials..."
          # Sign in and capture cookies
          LOGIN_RESPONSE=$(curl -s -c cookies.txt -b cookies.txt \
            -X POST "${BACKEND_URL}/api/auth/sign-in/email" \
            -H "Content-Type: application/json" \
            -H "Origin: http://localhost:3000" \
            -d '{"email":"admin@example.com","password":"password"}')

          echo "Login response: ${LOGIN_RESPONSE}"

          # Create an API key using better-auth API key plugin
          echo "Creating API key..."
          API_KEY_RESPONSE=$(curl -s -b cookies.txt \
            -X POST "${BACKEND_URL}/api/auth/api-key/create" \
            -H "Content-Type: application/json" \
            -H "Origin: http://localhost:3000" \
            -d '{"name":"terraform-acceptance-tests","expiresIn":604800}')

          echo "API key response: ${API_KEY_RESPONSE}"

          # Extract the key from the response
          API_KEY=$(echo "${API_KEY_RESPONSE}" | jq -r '.key')

          if [ -z "${API_KEY}" ] || [ "${API_KEY}" = "null" ]; then
            echo "Failed to create API key"
            echo "Response: ${API_KEY_RESPONSE}"
            exit 1
          fi

          echo "Successfully created API key"

          # Mask the API key in logs and set as output
          echo "::add-mask::${API_KEY}"
          echo "api-key=${API_KEY}" >> $GITHUB_OUTPUT

          # Cleanup
          rm -f cookies.txt

      - name: Run Acceptance Tests
        run: make testacc
        env:
          ARCHESTRA_BASE_URL: "http://localhost:9000"
          ARCHESTRA_API_KEY: ${{ steps.api-key.outputs.api-key }}

  zizmor:
    name: Zizmor GitHub Actions static analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      # From zizmor action docs:
      # https://github.com/zizmorcore/zizmor-action?tab=readme-ov-file#usage-with-github-advanced-security-recommended
      #
      # In this mode, the action will not fail when zizmor produces findings.
      # This is because Advanced Security encourages workflows to only fail on internal errors.
      #
      # To use workflow failure as a blocking signal, you can use GitHub's rulesets feature.
      # For more information, see:
      # https://docs.github.com/en/code-security/code-scanning/managing-code-scanning-alerts/about-code-scanning-alerts#pull-request-check-failures-for-code-scanning-alerts
      - name: Run zizmor ðŸŒˆ
        uses: zizmorcore/zizmor-action@e639db99335bc9038abc0e066dfcd72e23d26fb4 # v0.3.0
        with:
          config: .github/zizmor.yml
